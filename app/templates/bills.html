{% if fragment == "table_body" %}
{# --- Partial: full table body rows + summary --- #}
{% for bill in bills %}
<tr id="bill-row-{{ bill.id }}">
    <td>{{ bill.name }}</td>
    <td class="gw-text-muted">{{ bill.debtor_provider }}</td>
    <td class="text-right" data-sort-value="{{ bill.amount }}">${{ bill.amount|money }}</td>
    <td class="gw-text-muted">{{ frequency_labels.get(bill.frequency, bill.frequency) }}</td>
    <td class="gw-text-muted" data-sort-value="{{ bill.next_due_date }}">{{ bill.next_due_date }}</td>
    <td>
        <button hx-get="/bills/{{ bill.id }}/edit" hx-target="#bill-row-{{ bill.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        <button hx-delete="/bills/{{ bill.id }}" hx-target="#bill-row-{{ bill.id }}" hx-swap="delete"
                hx-confirm="Deactivate this bill?"
                class="gw-action-delete">Delete</button>
    </td>
</tr>
{% endfor %}

{% elif fragment == "bill_row" %}
{# --- Partial: single display row --- #}
<tr id="bill-row-{{ bill.id }}">
    <td>{{ bill.name }}</td>
    <td class="gw-text-muted">{{ bill.debtor_provider }}</td>
    <td class="text-right" data-sort-value="{{ bill.amount }}">${{ bill.amount|money }}</td>
    <td class="gw-text-muted">{{ frequency_labels.get(bill.frequency, bill.frequency) }}</td>
    <td class="gw-text-muted" data-sort-value="{{ bill.next_due_date }}">{{ bill.next_due_date }}</td>
    <td>
        <button hx-get="/bills/{{ bill.id }}/edit" hx-target="#bill-row-{{ bill.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        <button hx-delete="/bills/{{ bill.id }}" hx-target="#bill-row-{{ bill.id }}" hx-swap="delete"
                hx-confirm="Deactivate this bill?"
                class="gw-action-delete">Delete</button>
    </td>
</tr>

{% elif fragment == "edit_row" %}
{# --- Partial: inline edit row --- #}
<tr class="gw-edit-row" id="bill-row-{{ bill.id }}">
    <td>
        <input type="text" name="name" value="{{ bill.name }}" form="edit-form-{{ bill.id }}"
               class="gw-edit-input">
    </td>
    <td>
        <input type="text" name="debtor_provider" value="{{ bill.debtor_provider }}" form="edit-form-{{ bill.id }}"
               class="gw-edit-input">
    </td>
    <td>
        <input type="number" name="amount" value="{{ "%.2f"|format(bill.amount) }}" step="0.01" min="0.01"
               form="edit-form-{{ bill.id }}"
               class="gw-edit-input" style="text-align: right;">
    </td>
    <td>
        <select name="frequency" form="edit-form-{{ bill.id }}" class="gw-edit-input">
            {% for val, label in frequency_labels.items() %}
            <option value="{{ val }}" {{ 'selected' if bill.frequency == val }}>{{ label }}</option>
            {% endfor %}
        </select>
    </td>
    <td>
        <input type="date" name="next_due_date" value="{{ bill.next_due_date }}" form="edit-form-{{ bill.id }}"
               class="gw-edit-input">
    </td>
    <td>
        <form id="edit-form-{{ bill.id }}" hx-post="/bills/{{ bill.id }}" hx-target="#bill-row-{{ bill.id }}" hx-swap="outerHTML" style="display: inline;">
            <button type="submit" class="gw-btn gw-btn-success gw-btn-sm">Save</button>
        </form>
        <button class="gw-btn gw-btn-ghost gw-btn-sm"
                onclick="event.preventDefault(); location.reload();">Cancel</button>
    </td>
</tr>

{% else %}
{# --- Full page --- #}
{% extends "base.html" %}
{% block title %}Recurring Bills â€” Glow Worm{% endblock %}
{% block content %}
<div style="max-width: 1100px;">
    <h2 class="gw-page-header">Recurring Bills</h2>

    <div id="bills-message" style="margin-bottom: 16px;"></div>

    <!-- Add New Bill (collapsible) -->
    <details class="gw-details gw-section">
        <summary>Add New Bill</summary>
        <form hx-post="/bills" hx-target="#bills-table-body" hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('bills-message').innerHTML = '<p class=\'gw-msg-success\'>Bill added.</p>'; } else { document.getElementById('bills-message').innerHTML = event.detail.xhr.responseText; }"
              class="gw-grid-2" style="margin-top: 16px;">
            <div>
                <label for="bill-name" class="gw-label">Name</label>
                <input type="text" id="bill-name" name="name" required
                       class="gw-input" placeholder="e.g. Rent">
            </div>
            <div>
                <label for="bill-provider" class="gw-label">Provider</label>
                <input type="text" id="bill-provider" name="debtor_provider" required
                       class="gw-input" placeholder="e.g. Landlord">
            </div>
            <div>
                <label for="bill-amount" class="gw-label">Amount</label>
                <input type="number" id="bill-amount" name="amount" step="0.01" min="0.01" required
                       class="gw-input" placeholder="0.00">
            </div>
            <div>
                <label for="bill-frequency" class="gw-label">Frequency</label>
                <select id="bill-frequency" name="frequency" required class="gw-select">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                    <option value="28_days">Every 28 Days</option>
                </select>
            </div>
            <div>
                <label for="bill-start-date" class="gw-label">Start Date</label>
                <input type="date" id="bill-start-date" name="start_date" required class="gw-input">
            </div>
            <div>
                <label for="bill-next-due" class="gw-label">Next Due Date</label>
                <input type="date" id="bill-next-due" name="next_due_date" required class="gw-input">
            </div>
            <div style="grid-column: 1 / -1;">
                <button type="submit" class="gw-btn gw-btn-primary">Add Bill</button>
            </div>
        </form>
    </details>

    <!-- Summary bar -->
    <div class="gw-summary-bar gw-section">
        <div class="gw-summary-item">
            <span class="gw-summary-label">Monthly cost:</span>
            <span class="gw-summary-value">${{ total_monthly|money }}</span>
        </div>
        <div class="gw-summary-item">
            <span class="gw-summary-label">Annual cost:</span>
            <span class="gw-summary-value">${{ total_annual|money }}</span>
        </div>
    </div>

    <!-- Bills table -->
    <div class="gw-table-wrap">
        <div class="gw-overflow-x">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Provider</th>
                        <th class="text-right gw-sortable" onclick="sortBills('amount')">Amount <span class="gw-sort-indicator" id="sort-indicator-amount"></span></th>
                        <th>Frequency</th>
                        <th class="gw-sortable" onclick="sortBills('next_due_date')">Next Due <span class="gw-sort-indicator" id="sort-indicator-next_due_date"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bills-table-body">
                    {% for bill in bills %}
                    <tr id="bill-row-{{ bill.id }}">
                        <td>{{ bill.name }}</td>
                        <td class="gw-text-muted">{{ bill.debtor_provider }}</td>
                        <td class="text-right" data-sort-value="{{ bill.amount }}">${{ bill.amount|money }}</td>
                        <td class="gw-text-muted">{{ frequency_labels.get(bill.frequency, bill.frequency) }}</td>
                        <td class="gw-text-muted" data-sort-value="{{ bill.next_due_date }}">{{ bill.next_due_date }}</td>
                        <td>
                            <button hx-get="/bills/{{ bill.id }}/edit" hx-target="#bill-row-{{ bill.id }}" hx-swap="outerHTML"
                                    class="gw-action-edit">Edit</button>
                            <button hx-delete="/bills/{{ bill.id }}" hx-target="#bill-row-{{ bill.id }}" hx-swap="delete"
                                    hx-confirm="Deactivate this bill?"
                                    class="gw-action-delete">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
(function() {
    var currentSort = { key: null, dir: 'asc' };

    window.sortBills = function(key) {
        var tbody = document.getElementById('bills-table-body');
        var rows = Array.from(tbody.querySelectorAll('tr[id^="bill-row-"]'));

        if (currentSort.key === key) {
            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.key = key;
            currentSort.dir = 'asc';
        }

        var colIndex = key === 'amount' ? 2 : 4;

        rows.sort(function(a, b) {
            var aVal = a.children[colIndex].getAttribute('data-sort-value');
            var bVal = b.children[colIndex].getAttribute('data-sort-value');
            var cmp;
            if (key === 'amount') {
                cmp = parseFloat(aVal) - parseFloat(bVal);
            } else {
                cmp = aVal.localeCompare(bVal);
            }
            return currentSort.dir === 'asc' ? cmp : -cmp;
        });

        rows.forEach(function(row) { tbody.appendChild(row); });

        document.querySelectorAll('.gw-sort-indicator').forEach(function(el) { el.textContent = ''; });
        var indicator = document.getElementById('sort-indicator-' + key);
        if (indicator) {
            indicator.textContent = currentSort.dir === 'asc' ? ' \u25B2' : ' \u25BC';
        }
    };
})();
</script>
{% endblock %}
{% endif %}
