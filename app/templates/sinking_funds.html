{% if fragment == "table_body" %}
{# --- Partial: full table body rows --- #}
{% for fund in funds %}
<tr id="fund-row-{{ fund.id }}">
    <td>
        <span class="gw-dot" style="background-color: {{ fund.color }}"></span>{{ fund.name }}
    </td>
    <td class="gw-text-muted">{{ fund.description or "" }}</td>
    <td class="text-right">
        ${{ "%.2f"|format(fund.monthly_allocation) }}
        {% if fund.name == "Bills" and bills_recommended %}
        <span class="gw-text-dim" style="font-size: 0.75rem; margin-left: 4px;">Rec: ${{ bills_recommended }}</span>
        {% endif %}
    </td>
    <td class="text-right">${{ "%.2f"|format(fund.current_balance) }}</td>
    <td>
        <button hx-get="/sinking-funds/{{ fund.id }}/edit" hx-target="#fund-row-{{ fund.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        <button hx-delete="/sinking-funds/{{ fund.id }}" hx-target="#fund-row-{{ fund.id }}" hx-swap="delete"
                hx-confirm="Delete this sinking fund?"
                class="gw-action-delete">Delete</button>
    </td>
</tr>
{% endfor %}

{% elif fragment == "fund_row" %}
{# --- Partial: single display row --- #}
<tr id="fund-row-{{ fund.id }}">
    <td>
        <span class="gw-dot" style="background-color: {{ fund.color }}"></span>{{ fund.name }}
    </td>
    <td class="gw-text-muted">{{ fund.description or "" }}</td>
    <td class="text-right">
        ${{ "%.2f"|format(fund.monthly_allocation) }}
        {% if fund.name == "Bills" and bills_recommended %}
        <span class="gw-text-dim" style="font-size: 0.75rem; margin-left: 4px;">Rec: ${{ bills_recommended }}</span>
        {% endif %}
    </td>
    <td class="text-right">${{ "%.2f"|format(fund.current_balance) }}</td>
    <td>
        <button hx-get="/sinking-funds/{{ fund.id }}/edit" hx-target="#fund-row-{{ fund.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        <button hx-delete="/sinking-funds/{{ fund.id }}" hx-target="#fund-row-{{ fund.id }}" hx-swap="delete"
                hx-confirm="Delete this sinking fund?"
                class="gw-action-delete">Delete</button>
    </td>
</tr>

{% elif fragment == "edit_row" %}
{# --- Partial: inline edit row --- #}
<tr class="gw-edit-row" id="fund-row-{{ fund.id }}">
    <td>
        <div style="display: flex; align-items: center; gap: 8px;">
            <input type="color" name="color" value="{{ fund.color }}" form="edit-form-{{ fund.id }}"
                   style="width: 24px; height: 24px;">
            <input type="text" name="name" value="{{ fund.name }}" form="edit-form-{{ fund.id }}"
                   class="gw-edit-input">
        </div>
    </td>
    <td>
        <input type="text" name="description" value="{{ fund.description or '' }}" form="edit-form-{{ fund.id }}"
               class="gw-edit-input">
    </td>
    <td>
        <input type="number" name="monthly_allocation" value="{{ "%.2f"|format(fund.monthly_allocation) }}" step="0.01" min="0"
               form="edit-form-{{ fund.id }}"
               class="gw-edit-input" style="text-align: right;">
    </td>
    <td class="text-right gw-text-dim">
        ${{ "%.2f"|format(fund.current_balance) }}
    </td>
    <td>
        <form id="edit-form-{{ fund.id }}" hx-post="/sinking-funds/{{ fund.id }}" hx-target="#fund-row-{{ fund.id }}" hx-swap="outerHTML" style="display: inline;">
            <button type="submit" class="gw-btn gw-btn-success gw-btn-sm">Save</button>
        </form>
        <button class="gw-btn gw-btn-ghost gw-btn-sm"
                onclick="event.preventDefault(); location.reload();">Cancel</button>
    </td>
</tr>

{% else %}
{# --- Full page --- #}
{% extends "base.html" %}
{% block title %}Sinking Funds â€” Glow Worm{% endblock %}
{% block content %}
<div style="max-width: 1100px;">
    <h2 class="gw-page-header">Sinking Funds</h2>

    <div id="funds-message" style="margin-bottom: 16px;"></div>

    {% if buffer_warning %}
    <div class="gw-warning-banner gw-section">
        <strong>Buffer Warning:</strong> Your Bills fund balance is less than the ${{ bills_due_30 }} in bills due within the next 30 days.
    </div>
    {% endif %}

    <!-- Add New Fund (collapsible) -->
    <details class="gw-details gw-section">
        <summary>Add New Fund</summary>
        <form hx-post="/sinking-funds" hx-target="#funds-table-body" hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('funds-message').innerHTML = '<p class=\'gw-msg-success\'>Fund added.</p>'; } else { document.getElementById('funds-message').innerHTML = event.detail.xhr.responseText; }"
              class="gw-grid-2" style="margin-top: 16px;">
            <div>
                <label for="fund-name" class="gw-label">Name</label>
                <input type="text" id="fund-name" name="name" required
                       class="gw-input" placeholder="e.g. Emergency Fund">
            </div>
            <div>
                <label for="fund-description" class="gw-label">Description</label>
                <input type="text" id="fund-description" name="description"
                       class="gw-input" placeholder="Optional description">
            </div>
            <div>
                <label for="fund-allocation" class="gw-label">Monthly Allocation</label>
                <input type="number" id="fund-allocation" name="monthly_allocation" step="0.01" min="0" required
                       class="gw-input" placeholder="0.00">
            </div>
            <div>
                <label for="fund-balance" class="gw-label">Initial Balance</label>
                <input type="number" id="fund-balance" name="current_balance" step="0.01" value="0"
                       class="gw-input" placeholder="0.00">
            </div>
            <div>
                <label for="fund-color" class="gw-label">Color</label>
                <input type="color" id="fund-color" name="color" value="#3B82F6" required
                       style="width: 60px; height: 38px;">
            </div>
            <div style="grid-column: 1 / -1;">
                <button type="submit" class="gw-btn gw-btn-primary">Add Fund</button>
            </div>
        </form>
    </details>

    <!-- Summary bar -->
    <div class="gw-summary-bar gw-section">
        <div class="gw-summary-item">
            <span class="gw-summary-label">Total monthly allocation:</span>
            <span class="gw-summary-value">${{ total_monthly_allocation }}</span>
        </div>
        <div class="gw-summary-item">
            <span class="gw-summary-label">Total balance:</span>
            <span class="gw-summary-value">${{ total_balance }}</span>
        </div>
    </div>

    <!-- Funds table -->
    <div class="gw-table-wrap">
        <div class="gw-overflow-x">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th class="text-right">Monthly Allocation</th>
                        <th class="text-right">Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="funds-table-body">
                    {% for fund in funds %}
                    <tr id="fund-row-{{ fund.id }}">
                        <td>
                            <span class="gw-dot" style="background-color: {{ fund.color }}"></span>{{ fund.name }}
                        </td>
                        <td class="gw-text-muted">{{ fund.description or "" }}</td>
                        <td class="text-right">
                            ${{ "%.2f"|format(fund.monthly_allocation) }}
                            {% if fund.name == "Bills" and bills_recommended %}
                            <span class="gw-text-dim" style="font-size: 0.75rem; margin-left: 4px;">Rec: ${{ bills_recommended }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right">${{ "%.2f"|format(fund.current_balance) }}</td>
                        <td>
                            <button hx-get="/sinking-funds/{{ fund.id }}/edit" hx-target="#fund-row-{{ fund.id }}" hx-swap="outerHTML"
                                    class="gw-action-edit">Edit</button>
                            <button hx-delete="/sinking-funds/{{ fund.id }}" hx-target="#fund-row-{{ fund.id }}" hx-swap="delete"
                                    hx-confirm="Delete this sinking fund?"
                                    class="gw-action-delete">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% endif %}
