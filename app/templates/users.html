{% if fragment == "table_body" %}
{# --- Partial: full table body rows --- #}
{% for user in users %}
<tr id="user-row-{{ user.id }}">
    <td>{{ user.username }}</td>
    <td class="gw-text-muted">{{ user.email or "\u2014" }}</td>
    <td class="gw-text-muted">{{ user.created_at.strftime("%Y-%m-%d") }}</td>
    <td>
        <button hx-get="/users/{{ user.id }}/edit" hx-target="#user-row-{{ user.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        {% if user.id != current_user_id %}
        <button hx-delete="/users/{{ user.id }}" hx-target="#user-row-{{ user.id }}" hx-swap="delete"
                hx-confirm="Delete this user?"
                class="gw-action-delete">Delete</button>
        {% endif %}
    </td>
</tr>
{% endfor %}

{% elif fragment == "user_row" %}
{# --- Partial: single display row --- #}
<tr id="user-row-{{ user.id }}">
    <td>{{ user.username }}</td>
    <td class="gw-text-muted">{{ user.email or "\u2014" }}</td>
    <td class="gw-text-muted">{{ user.created_at.strftime("%Y-%m-%d") }}</td>
    <td>
        <button hx-get="/users/{{ user.id }}/edit" hx-target="#user-row-{{ user.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        {% if user.id != current_user_id %}
        <button hx-delete="/users/{{ user.id }}" hx-target="#user-row-{{ user.id }}" hx-swap="delete"
                hx-confirm="Delete this user?"
                class="gw-action-delete">Delete</button>
        {% endif %}
    </td>
</tr>

{% elif fragment == "edit_row" %}
{# --- Partial: inline edit row --- #}
<tr class="gw-edit-row" id="user-row-{{ user.id }}">
    <td>
        <input type="text" name="username" value="{{ user.username }}" form="edit-form-{{ user.id }}"
               class="gw-edit-input">
    </td>
    <td>
        <input type="email" name="email" value="{{ user.email or '' }}" form="edit-form-{{ user.id }}"
               class="gw-edit-input" placeholder="Optional">
    </td>
    <td>
        <input type="password" name="password" form="edit-form-{{ user.id }}"
               class="gw-edit-input" placeholder="Leave blank to keep" autocomplete="new-password">
    </td>
    <td>
        <form id="edit-form-{{ user.id }}" hx-post="/users/{{ user.id }}" hx-target="#user-row-{{ user.id }}" hx-swap="outerHTML" style="display: inline;">
            <button type="submit" class="gw-btn gw-btn-success gw-btn-sm">Save</button>
        </form>
        <button class="gw-btn gw-btn-ghost gw-btn-sm"
                onclick="event.preventDefault(); location.reload();">Cancel</button>
    </td>
</tr>

{% else %}
{# --- Full page --- #}
{% extends "base.html" %}
{% block title %}Users â€” Glow Worm{% endblock %}
{% block content %}
<div style="max-width: 900px;">
    <h2 class="gw-page-header">Users</h2>

    <div id="users-message" style="margin-bottom: 16px;"></div>

    <!-- Add New User (collapsible) -->
    <details class="gw-details gw-section">
        <summary>Add New User</summary>
        <form hx-post="/users" hx-target="#users-table-body" hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('users-message').innerHTML = '<p class=\'gw-msg-success\'>User added.</p>'; } else { document.getElementById('users-message').innerHTML = event.detail.xhr.responseText; }"
              class="gw-grid-2" style="margin-top: 16px;">
            <div>
                <label for="new-username" class="gw-label">Username</label>
                <input type="text" id="new-username" name="username" required
                       class="gw-input" placeholder="Username" autocomplete="off">
            </div>
            <div>
                <label for="new-email" class="gw-label">Email</label>
                <input type="email" id="new-email" name="email"
                       class="gw-input" placeholder="Optional">
            </div>
            <div>
                <label for="new-password" class="gw-label">Password</label>
                <input type="password" id="new-password" name="password" required minlength="8"
                       class="gw-input" placeholder="Min 8 characters" autocomplete="new-password">
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button type="submit" class="gw-btn gw-btn-primary">Add User</button>
            </div>
        </form>
    </details>

    <!-- Users table -->
    <div class="gw-table-wrap">
        <div class="gw-overflow-x">
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    {% for user in users %}
                    <tr id="user-row-{{ user.id }}">
                        <td>{{ user.username }}</td>
                        <td class="gw-text-muted">{{ user.email or "\u2014" }}</td>
                        <td class="gw-text-muted">{{ user.created_at.strftime("%Y-%m-%d") }}</td>
                        <td>
                            <button hx-get="/users/{{ user.id }}/edit" hx-target="#user-row-{{ user.id }}" hx-swap="outerHTML"
                                    class="gw-action-edit">Edit</button>
                            {% if user.id != current_user_id %}
                            <button hx-delete="/users/{{ user.id }}" hx-target="#user-row-{{ user.id }}" hx-swap="delete"
                                    hx-confirm="Delete this user?"
                                    class="gw-action-delete">Delete</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% endif %}
