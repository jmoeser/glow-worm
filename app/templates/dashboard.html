{% extends "base.html" %} {% block title %}Dashboard - Glow Worm{% endblock %}
{% block content %}
<h2 class="gw-page-header">{{ month_name }} {{ year }}</h2>

<!-- Summary Cards -->
<div class="gw-grid-4 gw-section">
    <div class="gw-stat gw-stat--green gw-animate-in">
        <p class="gw-stat-label">Total Income</p>
        <p class="gw-stat-value gw-text-positive">${{ total_income }}</p>
    </div>
    <div class="gw-stat gw-stat--red gw-animate-in">
        <p class="gw-stat-label">Total Expenses</p>
        <p class="gw-stat-value gw-text-negative">${{ total_expenses }}</p>
    </div>
    <div class="gw-stat {% if net >= 0 %}gw-stat--green{% else %}gw-stat--red{% endif %} gw-animate-in">
        <p class="gw-stat-label">Net</p>
        <p class="gw-stat-value {% if net >= 0 %}gw-text-positive{% else %}gw-text-negative{% endif %}">
            ${{ net }}
        </p>
    </div>
    <div class="gw-stat gw-stat--neutral gw-animate-in">
        <p class="gw-stat-label">Unallocated Income</p>
        <p class="gw-stat-value">${{ unallocated_income }}</p>
    </div>
</div>

<!-- Budget Overview -->
<div class="gw-card gw-section gw-animate-in">
    <h3 style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;">Budget Overview</h3>
    <div class="gw-grid-3" style="text-align: center;">
        <div>
            <p class="gw-stat-label">Allocated</p>
            <p style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700;">
                ${{ budget_total_allocated }}
            </p>
        </div>
        <div>
            <p class="gw-stat-label">Spent</p>
            <p style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700;" class="gw-text-negative">
                ${{ budget_total_spent }}
            </p>
        </div>
        <div>
            <p class="gw-stat-label">Remaining</p>
            <p style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700;"
               class="{% if budget_total_remaining >= 0 %}gw-text-positive{% else %}gw-text-negative{% endif %}">
                ${{ budget_total_remaining }}
            </p>
        </div>
    </div>
    {% if budget_total_allocated > 0 %}
    {% set pct = ((budget_total_spent / budget_total_allocated) * 100) | round(0) | int %}
    {% if pct > 100 %}{% set pct = 100 %}{% endif %}
    <div class="gw-progress" style="margin-top: 16px;">
        <div class="gw-progress-bar {% if pct > 90 %}gw-progress-bar--red{% elif pct > 70 %}gw-progress-bar--yellow{% else %}gw-progress-bar--green{% endif %}"
             style="width: {{ pct }}%"></div>
    </div>
    {% endif %}
</div>

<!-- Quick Expense -->
{% if budgets %}
<div class="gw-card gw-section gw-animate-in">
    <h3 style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;">Quick Expense</h3>
    <form
        hx-post="/dashboard/quick-expense"
        hx-target="#quick-expense-msg"
        hx-swap="innerHTML"
        class="gw-grid-4"
        style="align-items: end;"
    >
        <input type="hidden" name="month" value="{{ month }}" />
        <input type="hidden" name="year" value="{{ year }}" />
        <div>
            <label for="qe-budget" class="gw-label">Budget</label>
            <select id="qe-budget" name="budget_id" class="gw-select">
                <option value="">Select budget</option>
                {% for b in budgets %}
                <option value="{{ b.id }}">
                    {{ b.category.name }} (${{ "%.2f"|format(b.allocated_amount - b.spent_amount) }} left)
                </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="qe-amount" class="gw-label">Amount</label>
            <input id="qe-amount" type="number" name="amount" step="0.01" min="0.01"
                   placeholder="0.00" class="gw-input" />
        </div>
        <div>
            <label for="qe-date" class="gw-label">Date</label>
            <input id="qe-date" type="date" name="date" value="{{ now_date }}" class="gw-input" />
        </div>
        <div>
            <button type="submit" class="gw-btn gw-btn-primary" style="width: 100%;">
                Add Expense
            </button>
        </div>
    </form>
    <div id="quick-expense-msg" style="margin-top: 8px;"></div>
</div>
{% endif %}

<!-- Sinking Funds -->
<div class="gw-card gw-section gw-animate-in">
    <h3 style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; margin-bottom: 12px;">Sinking Funds</h3>
    {% if sinking_funds %}
    <ul class="gw-list-divider">
        {% for fund in sinking_funds %}
        <li>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="gw-dot" style="background-color: {{ fund.color }}"></span>
                <span>{{ fund.name }}</span>
            </div>
            <span style="font-family: var(--font-display); font-weight: 600;">
                ${{ "%.2f"|format(fund.current_balance) }}
            </span>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="gw-text-dim" style="font-size: 0.875rem;">No sinking funds configured.</p>
    {% endif %}
</div>

<!-- Recent Transactions -->
<div class="gw-animate-in">
    <div class="gw-table-wrap">
        <div style="padding: 16px 16px 0;">
            <h3 style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; margin-bottom: 12px;">
                Recent Transactions
            </h3>
        </div>
        {% if recent_transactions %}
        <div class="gw-overflow-x">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th class="text-right">Amount</th>
                        <th>Category</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for txn in recent_transactions %}
                    <tr>
                        <td style="white-space: nowrap;">{{ txn.date }}</td>
                        <td>{{ txn.description or "\u2014" }}</td>
                        <td class="text-right" style="font-weight: 600; color: {% if txn.type == 'income' %}var(--positive){% else %}var(--negative){% endif %};">
                            ${{ "%.2f"|format(txn.amount) }}
                        </td>
                        <td>
                            {{ txn.category.name if txn.category else "\u2014" }}
                        </td>
                        <td>
                            {% if txn.is_paid %}
                            <span class="gw-badge gw-badge--paid">Paid</span>
                            {% else %}
                            <span class="gw-badge gw-badge--pending">Pending</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="gw-text-dim" style="padding: 0 16px 16px; font-size: 0.875rem;">No transactions this month.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
