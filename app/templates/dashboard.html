{% extends "base.html" %} {% block title %}Dashboard - Glow Worm{% endblock %}
{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-100">
        {{ month_name }} {{ year }}
    </h2>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5">
        <p class="text-sm text-gray-400">Total Income</p>
        <p class="text-2xl font-bold text-green-400">${{ total_income }}</p>
    </div>
    <div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5">
        <p class="text-sm text-gray-400">Total Expenses</p>
        <p class="text-2xl font-bold text-red-400">${{ total_expenses }}</p>
    </div>
    <div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5">
        <p class="text-sm text-gray-400">Net</p>
        <p
            class="text-2xl font-bold {% if net >= 0 %}text-green-400{% else %}text-red-400{% endif %}"
        >
            ${{ net }}
        </p>
    </div>
    <div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5">
        <p class="text-sm text-gray-400">Unallocated Income</p>
        <p class="text-2xl font-bold text-gray-100">
            ${{ unallocated_income }}
        </p>
    </div>
</div>

<!-- Budget Overview -->
<div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5 mb-8">
    <h3 class="text-lg font-semibold text-gray-100 mb-3">Budget Overview</h3>
    <div class="grid grid-cols-3 gap-4 text-center">
        <div>
            <p class="text-sm text-gray-400">Allocated</p>
            <p class="text-xl font-bold text-gray-100">
                ${{ budget_total_allocated }}
            </p>
        </div>
        <div>
            <p class="text-sm text-gray-400">Spent</p>
            <p class="text-xl font-bold text-red-400">
                ${{ budget_total_spent }}
            </p>
        </div>
        <div>
            <p class="text-sm text-gray-400">Remaining</p>
            <p
                class="text-xl font-bold {% if budget_total_remaining >= 0 %}text-green-400{% else %}text-red-400{% endif %}"
            >
                ${{ budget_total_remaining }}
            </p>
        </div>
    </div>
    {% if budget_total_allocated > 0 %}
    <div class="mt-4 w-full bg-gray-700 rounded-full h-3">
        {% set pct = ((budget_total_spent / budget_total_allocated) * 100) |
        round(0) | int %} {% if pct > 100 %}{% set pct = 100 %}{% endif %}
        <div
            class="{% if pct > 90 %}bg-red-500{% elif pct > 70 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-3 rounded-full"
            style="width: {{ pct }}%"
        ></div>
    </div>
    {% endif %}
</div>

<!-- Quick Expense -->
{% if budgets %}
<div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5 mb-8">
    <h3 class="text-lg font-semibold text-gray-100 mb-3">Quick Expense</h3>
    <form
        hx-post="/dashboard/quick-expense"
        hx-target="#quick-expense-msg"
        hx-swap="innerHTML"
        class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end"
    >
        <input type="hidden" name="month" value="{{ month }}" />
        <input type="hidden" name="year" value="{{ year }}" />
        <div>
            <label for="qe-budget" class="block text-sm text-gray-400 mb-1">Budget</label>
            <select
                id="qe-budget"
                name="budget_id"
                class="w-full rounded-md bg-gray-800 border border-gray-700 text-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                <option value="">Select budget</option>
                {% for b in budgets %}
                <option value="{{ b.id }}">
                    {{ b.category.name }} (${{ "%.2f"|format(b.allocated_amount - b.spent_amount) }} left)
                </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="qe-amount" class="block text-sm text-gray-400 mb-1">Amount</label>
            <input
                id="qe-amount"
                type="number"
                name="amount"
                step="0.01"
                min="0.01"
                placeholder="0.00"
                class="w-full rounded-md bg-gray-800 border border-gray-700 text-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
        </div>
        <div>
            <label for="qe-date" class="block text-sm text-gray-400 mb-1">Date</label>
            <input
                id="qe-date"
                type="date"
                name="date"
                value="{{ now_date }}"
                class="w-full rounded-md bg-gray-800 border border-gray-700 text-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
        </div>
        <div>
            <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md px-4 py-2 text-sm transition-colors"
            >
                Add Expense
            </button>
        </div>
    </form>
    <div id="quick-expense-msg" class="mt-2"></div>
</div>
{% endif %}

<!-- Sinking Funds -->
<div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5 mb-8">
    <h3 class="text-lg font-semibold text-gray-100 mb-3">Sinking Funds</h3>
    {% if sinking_funds %}
    <ul class="divide-y divide-gray-700">
        {% for fund in sinking_funds %}
        <li class="py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span
                    class="inline-block w-3 h-3 rounded-full"
                    style="background-color: {{ fund.color }}"
                ></span>
                <span class="text-gray-100">{{ fund.name }}</span>
            </div>
            <span class="font-semibold text-gray-100"
                >${{ "%.2f"|format(fund.current_balance) }}</span
            >
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-gray-400">No sinking funds configured.</p>
    {% endif %}
</div>

<!-- Recent Transactions -->
<div class="bg-gray-900 rounded-lg shadow border border-gray-800 p-5">
    <h3 class="text-lg font-semibold text-gray-100 mb-3">
        Recent Transactions
    </h3>
    {% if recent_transactions %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
            <thead class="text-gray-400 border-b border-gray-700">
                <tr>
                    <th class="py-2 pr-4">Date</th>
                    <th class="py-2 pr-4">Description</th>
                    <th class="py-2 pr-4">Amount</th>
                    <th class="py-2 pr-4">Category</th>
                    <th class="py-2">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-800">
                {% for txn in recent_transactions %}
                <tr>
                    <td class="py-2 pr-4 whitespace-nowrap text-gray-300">{{ txn.date }}</td>
                    <td class="py-2 pr-4 text-gray-300">{{ txn.description or "—" }}</td>
                    <td
                        class="py-2 pr-4 font-medium {% if txn.type == 'income' %}text-green-400{% else %}text-red-400{% endif %}"
                    >
                        ${{ "%.2f"|format(txn.amount) }}
                    </td>
                    <td class="py-2 pr-4 text-gray-300">
                        {{ txn.category.name if txn.category else "—" }}
                    </td>
                    <td class="py-2">
                        {% if txn.is_paid %}
                        <span class="text-green-400">Paid</span>
                        {% else %}
                        <span class="text-yellow-400">Pending</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-400">No transactions this month.</p>
    {% endif %}
</div>
{% endblock %}
