{% if fragment == "table_body" %}
{# --- Partial: full table body rows --- #}
{% for txn in transactions %}
<tr id="txn-row-{{ txn.id }}">
    <td class="gw-text-muted" style="white-space: nowrap;">{{ txn.date }}</td>
    <td class="gw-text-muted">{{ txn.description or "" }}</td>
    <td class="text-right" style="font-weight: 600; color: {% if txn.type == 'income' %}var(--positive){% else %}var(--negative){% endif %};">
        {% if txn.type == 'income' %}+{% else %}-{% endif %}${{ txn.amount|money }}
    </td>
    <td>
        <span class="gw-dot" style="background-color: {{ txn.category.color }}"></span>{{ txn.category.name }}
    </td>
    <td class="gw-text-muted">{{ transaction_type_labels.get(txn.transaction_type, txn.transaction_type) }}</td>
    <td class="gw-text-muted">
        {% if txn.sinking_fund %}{{ txn.sinking_fund.name }}{% endif %}
        {% if txn.recurring_bill %}{{ txn.recurring_bill.name }}{% endif %}
        {% if txn.budget and txn.budget.category %}{{ txn.budget.category.name }} Budget{% endif %}
    </td>
    <td>
        {% if txn.is_paid %}
        <span class="gw-badge gw-badge--paid">Paid</span>
        {% else %}
        <span class="gw-badge gw-badge--pending">Pending</span>
        {% endif %}
    </td>
    <td>
        <button hx-get="/transactions/{{ txn.id }}/edit" hx-target="#txn-row-{{ txn.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        <button hx-delete="/transactions/{{ txn.id }}" hx-target="#txn-row-{{ txn.id }}" hx-swap="delete"
                hx-confirm="Delete this transaction?"
                class="gw-action-delete">Delete</button>
    </td>
</tr>
{% endfor %}

{% elif fragment == "transaction_row" %}
{# --- Partial: single display row --- #}
<tr id="txn-row-{{ txn.id }}">
    <td class="gw-text-muted" style="white-space: nowrap;">{{ txn.date }}</td>
    <td class="gw-text-muted">{{ txn.description or "" }}</td>
    <td class="text-right" style="font-weight: 600; color: {% if txn.type == 'income' %}var(--positive){% else %}var(--negative){% endif %};">
        {% if txn.type == 'income' %}+{% else %}-{% endif %}${{ txn.amount|money }}
    </td>
    <td>
        <span class="gw-dot" style="background-color: {{ txn.category.color }}"></span>{{ txn.category.name }}
    </td>
    <td class="gw-text-muted">{{ transaction_type_labels.get(txn.transaction_type, txn.transaction_type) }}</td>
    <td class="gw-text-muted">
        {% if txn.sinking_fund %}{{ txn.sinking_fund.name }}{% endif %}
        {% if txn.recurring_bill %}{{ txn.recurring_bill.name }}{% endif %}
        {% if txn.budget and txn.budget.category %}{{ txn.budget.category.name }} Budget{% endif %}
    </td>
    <td>
        {% if txn.is_paid %}
        <span class="gw-badge gw-badge--paid">Paid</span>
        {% else %}
        <span class="gw-badge gw-badge--pending">Pending</span>
        {% endif %}
    </td>
    <td>
        <button hx-get="/transactions/{{ txn.id }}/edit" hx-target="#txn-row-{{ txn.id }}" hx-swap="outerHTML"
                class="gw-action-edit">Edit</button>
        <button hx-delete="/transactions/{{ txn.id }}" hx-target="#txn-row-{{ txn.id }}" hx-swap="delete"
                hx-confirm="Delete this transaction?"
                class="gw-action-delete">Delete</button>
    </td>
</tr>

{% elif fragment == "edit_row" %}
{# --- Partial: inline edit row --- #}
<tr class="gw-edit-row" id="txn-row-{{ txn.id }}">
    <td>
        <input type="date" name="date" value="{{ txn.date }}" form="edit-form-{{ txn.id }}"
               class="gw-edit-input">
    </td>
    <td>
        <input type="text" name="description" value="{{ txn.description or '' }}" form="edit-form-{{ txn.id }}"
               class="gw-edit-input">
    </td>
    <td>
        <input type="number" name="amount" value="{{ "%.2f"|format(txn.amount) }}" step="0.01" min="0.01"
               form="edit-form-{{ txn.id }}"
               class="gw-edit-input" style="text-align: right;">
    </td>
    <td>
        <select name="category_id" form="edit-form-{{ txn.id }}" class="gw-edit-input">
            {% for cat in categories %}
            <option value="{{ cat.id }}" {{ 'selected' if txn.category_id == cat.id }}>{{ cat.name }}</option>
            {% endfor %}
        </select>
    </td>
    <td>
        <select name="transaction_type" form="edit-form-{{ txn.id }}" class="gw-edit-input">
            {% for val, label in transaction_type_labels.items() %}
            <option value="{{ val }}" {{ 'selected' if txn.transaction_type == val }}>{{ label }}</option>
            {% endfor %}
        </select>
    </td>
    <td>
        <select name="sinking_fund_id" form="edit-form-{{ txn.id }}" class="gw-edit-input">
            <option value="">None</option>
            {% for sf in sinking_funds %}
            <option value="{{ sf.id }}" {{ 'selected' if txn.sinking_fund_id == sf.id }}>{{ sf.name }}</option>
            {% endfor %}
        </select>
        <select name="recurring_bill_id" form="edit-form-{{ txn.id }}" class="gw-edit-input" style="margin-top: 4px;">
            <option value="">No Bill</option>
            {% for rb in recurring_bills %}
            <option value="{{ rb.id }}" {{ 'selected' if txn.recurring_bill_id == rb.id }}>{{ rb.name }}</option>
            {% endfor %}
        </select>
    </td>
    <td>
        <select name="type" form="edit-form-{{ txn.id }}" class="gw-edit-input">
            <option value="income" {{ 'selected' if txn.type == 'income' }}>Income</option>
            <option value="expense" {{ 'selected' if txn.type == 'expense' }}>Expense</option>
        </select>
    </td>
    <td>
        <form id="edit-form-{{ txn.id }}" hx-post="/transactions/{{ txn.id }}" hx-target="#txn-row-{{ txn.id }}" hx-swap="outerHTML" style="display: inline;">
            <button type="submit" class="gw-btn gw-btn-success gw-btn-sm">Save</button>
        </form>
        <button onclick="event.preventDefault(); location.reload();"
                class="gw-btn gw-btn-ghost gw-btn-sm">Cancel</button>
    </td>
</tr>

{% else %}
{# --- Full page --- #}
{% extends "base.html" %}
{% block title %}Transactions â€” Glow Worm{% endblock %}
{% block content %}
<div style="max-width: 1200px;">
    <h2 class="gw-page-header">Transactions</h2>

    <!-- Month navigation -->
    <div class="gw-month-nav gw-section">
        <a href="/transactions?month={{ prev_month }}&year={{ prev_year }}{% if type_filter %}&type_filter={{ type_filter }}{% endif %}{% if category_filter %}&category_id={{ category_filter }}{% endif %}">&larr; Previous</a>
        <span>{{ month_name }} {{ year }}</span>
        <a href="/transactions?month={{ next_month }}&year={{ next_year }}{% if type_filter %}&type_filter={{ type_filter }}{% endif %}{% if category_filter %}&category_id={{ category_filter }}{% endif %}">Next &rarr;</a>
    </div>

    <!-- Filter bar -->
    <form method="get" action="/transactions" class="gw-filter-bar gw-section">
        <input type="hidden" name="month" value="{{ month }}">
        <input type="hidden" name="year" value="{{ year }}">
        <div>
            <label class="gw-label">Type</label>
            <select name="type_filter" class="gw-select" style="min-width: 140px;">
                <option value="">All Types</option>
                <option value="income" {{ 'selected' if type_filter == 'income' }}>Income</option>
                <option value="expense" {{ 'selected' if type_filter == 'expense' }}>Expense</option>
            </select>
        </div>
        <div>
            <label class="gw-label">Category</label>
            <select name="category_id" class="gw-select" style="min-width: 140px;">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {{ 'selected' if category_filter|string == cat.id|string }}>{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="gw-btn gw-btn-primary gw-btn-sm">Filter</button>
        <a href="/transactions?month={{ month }}&year={{ year }}" style="color: var(--text-tertiary); text-decoration: none; font-size: 0.85rem;">Clear</a>
    </form>

    <div id="transactions-message" style="margin-bottom: 16px;"></div>

    <!-- Add Transaction (collapsible) -->
    <details class="gw-details gw-section">
        <summary>Add Transaction</summary>
        <form hx-post="/transactions" hx-target="#transactions-table-body" hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('transactions-message').innerHTML = '<p class=\'gw-msg-success\'>Transaction added.</p>'; } else { document.getElementById('transactions-message').innerHTML = event.detail.xhr.responseText; }"
              class="gw-grid-3" style="margin-top: 16px;">
            <input type="hidden" name="month" value="{{ month }}">
            <input type="hidden" name="year" value="{{ year }}">
            <div>
                <label class="gw-label">Date</label>
                <input type="date" name="date" required class="gw-input">
            </div>
            <div>
                <label class="gw-label">Description</label>
                <input type="text" name="description" class="gw-input" placeholder="Optional description">
            </div>
            <div>
                <label class="gw-label">Amount</label>
                <input type="number" name="amount" step="0.01" min="0.01" required class="gw-input" placeholder="0.00">
            </div>
            <div>
                <label class="gw-label">Category</label>
                <select name="category_id" required class="gw-select">
                    <option value="">Select category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="gw-label">Type</label>
                <select name="type" required class="gw-select">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>
            <div>
                <label class="gw-label">Transaction Type</label>
                <select name="transaction_type" class="gw-select">
                    {% for val, label in transaction_type_labels.items() %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="gw-label">Sinking Fund</label>
                <select name="sinking_fund_id" class="gw-select">
                    <option value="">None</option>
                    {% for sf in sinking_funds %}
                    <option value="{{ sf.id }}">{{ sf.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="gw-label">Recurring Bill</label>
                <select name="recurring_bill_id" class="gw-select">
                    <option value="">None</option>
                    {% for rb in recurring_bills %}
                    <option value="{{ rb.id }}">{{ rb.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="gw-label">Budget</label>
                <select name="budget_id" class="gw-select">
                    <option value="">None</option>
                    {% for b in budgets %}
                    <option value="{{ b.id }}">{{ b.category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="is_paid" checked>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Paid</span>
                </label>
            </div>
            <div style="grid-column: 1 / -1;">
                <button type="submit" class="gw-btn gw-btn-primary">Add Transaction</button>
            </div>
        </form>
    </details>

    <!-- Summary bar -->
    <div class="gw-summary-bar gw-section">
        <div class="gw-summary-item">
            <span class="gw-summary-label">Income:</span>
            <span class="gw-summary-value gw-text-positive">${{ total_income|money }}</span>
        </div>
        <div class="gw-summary-item">
            <span class="gw-summary-label">Expenses:</span>
            <span class="gw-summary-value gw-text-negative">${{ total_expenses|money }}</span>
        </div>
        <div class="gw-summary-item">
            <span class="gw-summary-label">Net:</span>
            <span class="gw-summary-value" style="color: {% if net < 0 %}var(--negative){% else %}var(--positive){% endif %};">${{ net|money }}</span>
        </div>
    </div>

    <!-- Transactions table -->
    <div class="gw-table-wrap">
        <div class="gw-overflow-x">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th class="text-right">Amount</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Linked</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body">
                    {% for txn in transactions %}
                    <tr id="txn-row-{{ txn.id }}">
                        <td class="gw-text-muted" style="white-space: nowrap;">{{ txn.date }}</td>
                        <td class="gw-text-muted">{{ txn.description or "" }}</td>
                        <td class="text-right" style="font-weight: 600; color: {% if txn.type == 'income' %}var(--positive){% else %}var(--negative){% endif %};">
                            {% if txn.type == 'income' %}+{% else %}-{% endif %}${{ txn.amount|money }}
                        </td>
                        <td>
                            <span class="gw-dot" style="background-color: {{ txn.category.color }}"></span>{{ txn.category.name }}
                        </td>
                        <td class="gw-text-muted">{{ transaction_type_labels.get(txn.transaction_type, txn.transaction_type) }}</td>
                        <td class="gw-text-muted">
                            {% if txn.sinking_fund %}{{ txn.sinking_fund.name }}{% endif %}
                            {% if txn.recurring_bill %}{{ txn.recurring_bill.name }}{% endif %}
                            {% if txn.budget and txn.budget.category %}{{ txn.budget.category.name }} Budget{% endif %}
                        </td>
                        <td>
                            {% if txn.is_paid %}
                            <span class="gw-badge gw-badge--paid">Paid</span>
                            {% else %}
                            <span class="gw-badge gw-badge--pending">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            <button hx-get="/transactions/{{ txn.id }}/edit" hx-target="#txn-row-{{ txn.id }}" hx-swap="outerHTML"
                                    class="gw-action-edit">Edit</button>
                            <button hx-delete="/transactions/{{ txn.id }}" hx-target="#txn-row-{{ txn.id }}" hx-swap="delete"
                                    hx-confirm="Delete this transaction?"
                                    class="gw-action-delete">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% endif %}
