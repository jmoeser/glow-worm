{% extends "base.html" %}
{% block title %}Income Allocation â€” Glow Worm{% endblock %}
{% block content %}
<div style="max-width: 1100px;">
    <h2 class="gw-page-header">Income Allocation Settings</h2>

    <div id="income-message" style="margin-bottom: 16px;"></div>

    <!-- Sankey Diagram -->
    <div class="gw-section">
        <h3 style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; margin-bottom: 12px;">Income Breakdown</h3>
        <div id="sankey-chart" class="gw-sankey-wrap">
            <p class="gw-text-dim" style="font-size: 0.875rem;">Enter an income to see the breakdown</p>
        </div>
    </div>

    <div style="max-width: 460px; margin: 0 auto;">
        <form hx-post="/income" hx-target="#income-message" hx-swap="innerHTML" style="display: flex; flex-direction: column; gap: 20px;">

                <!-- Monthly Income -->
                <div>
                    <label for="monthly_income_amount" class="gw-label">Monthly Income</label>
                    <input type="number" id="monthly_income_amount" name="monthly_income_amount"
                           step="0.01" min="0"
                           value="{{ allocation.monthly_income_amount if allocation else '' }}"
                           oninput="calculateRemainder()"
                           class="gw-input"
                           placeholder="0.00" required>
                </div>

                <!-- Monthly Budget Allocation -->
                <div>
                    <label for="monthly_budget_allocation" class="gw-label">Monthly Budget Allocation</label>
                    <input type="number" id="monthly_budget_allocation" name="monthly_budget_allocation"
                           step="0.01" min="0"
                           value="{{ allocation.monthly_budget_allocation if allocation else '' }}"
                           oninput="calculateRemainder()"
                           class="gw-input"
                           placeholder="0.00">
                </div>

                <!-- Bills Fund Allocation -->
                <fieldset class="gw-fieldset">
                    <legend>Bills Fund Allocation</legend>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="bills_fund_allocation_type" value="recommended"
                                   {{ 'checked' if not allocation or allocation.bills_fund_allocation_type == 'recommended' }}
                                   onchange="toggleFixedAmount()">
                            <span style="font-size: 0.875rem; color: var(--text-secondary);">Recommended (auto-calculated)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="bills_fund_allocation_type" value="fixed"
                                   {{ 'checked' if allocation and allocation.bills_fund_allocation_type == 'fixed' }}
                                   onchange="toggleFixedAmount()">
                            <span style="font-size: 0.875rem; color: var(--text-secondary);">Fixed amount</span>
                        </label>
                        <div id="fixed-amount-container"
                             class="{{ '' if allocation and allocation.bills_fund_allocation_type == 'fixed' else 'hidden' }}">
                            <input type="number" id="bills_fund_fixed_amount" name="bills_fund_fixed_amount"
                                   step="0.01" min="0"
                                   value="{{ allocation.bills_fund_fixed_amount if allocation and allocation.bills_fund_fixed_amount else '' }}"
                                   class="gw-input"
                                   placeholder="0.00">
                        </div>
                    </div>
                </fieldset>

                <!-- Sinking Fund Allocations -->
                <fieldset class="gw-fieldset">
                    <legend>Sinking Fund Allocations</legend>
                    {% if sinking_funds %}
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        {% for fund in sinking_funds %}
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="gw-dot" style="background-color: {{ fund.color }}"></span>
                            <label for="fund_{{ fund.id }}" style="font-size: 0.875rem; color: var(--text-secondary); width: 120px;">{{ fund.name }}</label>
                            <input type="number" id="fund_{{ fund.id }}" name="fund_{{ fund.id }}"
                                   step="0.01" min="0"
                                   value="{{ fund_allocation_map.get(fund.id, '') }}"
                                   oninput="calculateRemainder()"
                                   class="gw-input" style="flex: 1;"
                                   placeholder="0.00">
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="gw-text-dim" style="font-size: 0.875rem;">No active sinking funds.</p>
                    {% endif %}
                </fieldset>

                <!-- Remainder Display -->
                <div id="remainder-display" class="gw-remainder gw-remainder--neutral">
                    Remainder: <span id="remainder-value">$0.00</span>
                </div>

                <!-- Save Button -->
                <button type="submit" class="gw-btn gw-btn-primary" style="width: 100%;">
                    Save Allocation
                </button>
            </form>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<script>
const FUND_META = {{ sinking_funds_data | tojson }};

function calculateRemainder() {
    const income = parseFloat(document.getElementById('monthly_income_amount').value) || 0;
    const budget = parseFloat(document.getElementById('monthly_budget_allocation').value) || 0;

    let fundTotal = 0;
    document.querySelectorAll('input[name^="fund_"]').forEach(function(input) {
        fundTotal += parseFloat(input.value) || 0;
    });

    const remainder = income - budget - fundTotal;
    const el = document.getElementById('remainder-value');
    el.textContent = '$' + remainder.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    const container = document.getElementById('remainder-display');
    if (remainder >= 0) {
        container.className = 'gw-remainder gw-remainder--positive';
    } else {
        container.className = 'gw-remainder gw-remainder--negative';
    }

    renderSankey();
}

function toggleFixedAmount() {
    const fixed = document.querySelector('input[name="bills_fund_allocation_type"][value="fixed"]');
    const container = document.getElementById('fixed-amount-container');
    if (fixed.checked) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function renderSankey() {
    const container = document.getElementById('sankey-chart');
    const income = parseFloat(document.getElementById('monthly_income_amount').value) || 0;

    if (income <= 0) {
        container.innerHTML = '<p class="gw-text-dim" style="font-size: 0.875rem;">Enter an income to see the breakdown</p>';
        return;
    }

    const budget = parseFloat(document.getElementById('monthly_budget_allocation').value) || 0;

    // Collect fund allocations
    const fundAllocations = [];
    FUND_META.forEach(function(fund) {
        const input = document.getElementById('fund_' + fund.id);
        const amount = input ? (parseFloat(input.value) || 0) : 0;
        if (amount > 0) {
            fundAllocations.push({ id: fund.id, name: fund.name, color: fund.color, amount: amount });
        }
    });

    const totalAllocated = budget + fundAllocations.reduce(function(sum, f) { return sum + f.amount; }, 0);
    const remainder = income - totalAllocated;

    // Build nodes: index 0 = Income (source)
    const nodes = [{ name: 'Income', color: '#34d399' }];
    const links = [];

    if (budget > 0) {
        const idx = nodes.length;
        nodes.push({ name: 'Monthly Budget', color: '#60A5FA' });
        links.push({ source: 0, target: idx, value: budget, color: '#60A5FA' });
    }

    fundAllocations.forEach(function(fund) {
        const idx = nodes.length;
        nodes.push({ name: fund.name, color: fund.color });
        links.push({ source: 0, target: idx, value: fund.amount, color: fund.color });
    });

    if (remainder > 0) {
        const idx = nodes.length;
        nodes.push({ name: 'Unallocated', color: '#5f6775' });
        links.push({ source: 0, target: idx, value: remainder, color: '#5f6775' });
    }

    if (links.length === 0) {
        nodes.push({ name: 'Unallocated', color: '#5f6775' });
        links.push({ source: 0, target: 1, value: income, color: '#5f6775' });
    }

    // Dimensions
    const width = container.clientWidth;
    const nodeCount = nodes.length;
    const height = Math.max(250, nodeCount * 50);

    const margin = { top: 16, right: 200, bottom: 16, left: 16 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    // Clear container and create SVG
    container.innerHTML = '';
    const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    // Define gradients
    const defs = svg.append('defs');

    // Sankey layout
    const sankey = d3.sankey()
        .nodeId(function(d) { return d.index; })
        .nodeWidth(20)
        .nodePadding(16)
        .nodeAlign(d3.sankeyLeft)
        .extent([[margin.left, margin.top], [margin.left + innerWidth, margin.top + innerHeight]]);

    const graph = sankey({
        nodes: nodes.map(function(d, i) { return Object.assign({}, d, { index: i }); }),
        links: links.map(function(d) { return Object.assign({}, d); })
    });

    // Draw links
    svg.append('g')
        .selectAll('path')
        .data(graph.links)
        .join('path')
        .attr('d', d3.sankeyLinkHorizontal())
        .attr('fill', 'none')
        .attr('stroke', function(d) { return d.color; })
        .attr('stroke-opacity', 0.4)
        .attr('stroke-width', function(d) { return Math.max(1, d.width); });

    // Draw nodes
    svg.append('g')
        .selectAll('rect')
        .data(graph.nodes)
        .join('rect')
        .attr('x', function(d) { return d.x0; })
        .attr('y', function(d) { return d.y0; })
        .attr('width', function(d) { return d.x1 - d.x0; })
        .attr('height', function(d) { return Math.max(1, d.y1 - d.y0); })
        .attr('fill', function(d) { return d.color; })
        .attr('rx', 3);

    // Format helpers
    function fmt(amount) {
        return '$' + amount.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function pct(amount) {
        return (amount / income * 100).toFixed(1) + '%';
    }

    // Node labels
    svg.append('g')
        .selectAll('text')
        .data(graph.nodes)
        .join('text')
        .attr('x', function(d) { return d.x1 + 8; })
        .attr('y', function(d) { return (d.y0 + d.y1) / 2; })
        .attr('dy', '0.35em')
        .attr('font-size', '12px')
        .attr('font-family', 'DM Sans, system-ui, sans-serif')
        .attr('fill', '#9aa0ab')
        .text(function(d) {
            var val = d.sourceLinks.length > 0
                ? d.sourceLinks.reduce(function(s, l) { return s + l.value; }, 0)
                : d.targetLinks.reduce(function(s, l) { return s + l.value; }, 0);
            return d.name + '  ' + fmt(val) + ' (' + pct(val) + ')';
        });
}

// Run on page load to set initial state
document.addEventListener('DOMContentLoaded', function() {
    calculateRemainder();
    toggleFixedAmount();
});
</script>
{% endblock %}
